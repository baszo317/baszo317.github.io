<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>簡易購物平台</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #product-section, #user-section, #checkout-section {
      margin: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      width: 300px;
    }

    .product {
      margin-bottom: 15px;
    }

    .cart {
      display: none;
    }

    .cart.active {
      display: block;
    }

    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-item button {
      margin-left: 5px;
    }

    #product-error-msg, #user-error-msg {
      color: red;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://sebftfqvlzecsezcfxrq.supabase.co'; // 替換為您的 Supabase URL
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlYmZ0ZnF2bHplY3NlemNmeHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ3NjM4MzQsImV4cCI6MjA1MDMzOTgzNH0.FdZw3Wf6gh6TdUO4mdnRIKULZ3iog3H0RS2IMMt1DHE'; // 替換為您的 Supabase 匿名金鑰
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    document.addEventListener('DOMContentLoaded', () => {
      renderProductList();
      renderUserList();

      // 即時監控數據變化
      supabase
        .channel('realtime-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, renderProductList)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, renderUserList)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'cart_items' }, () => {
          if (currentUser) updateCartDisplay(currentUser);
        })
        .subscribe();
    });

    // 新增商品
    async function addProduct() {
      const name = document.getElementById('product-name').value.trim();
      const price = parseFloat(document.getElementById('product-price').value);
      const errorMsg = document.getElementById('product-error-msg');

      if (!name || isNaN(price) || price <= 0) {
        errorMsg.textContent = '請輸入有效的商品名稱和價格！';
        return;
      }

      try {
        errorMsg.textContent = '';
        const { data, error } = await supabase.from('products').insert([{ name, price }]);

        if (error) {
          errorMsg.textContent = `新增商品失敗: ${error.message}`;
          console.error(error);
        } else {
          alert("商品新增成功！");
          renderProductList();
        }
      } catch (err) {
        errorMsg.textContent = `新增商品時發生錯誤: ${err.message}`;
        console.error(err);
      }

      document.getElementById('product-name').value = '';
      document.getElementById('product-price').value = '';
    }

    // 渲染商品列表
    async function renderProductList() {
      const productsDiv = document.getElementById('products');
      productsDiv.innerHTML = '';

      try {
        const { data: products, error } = await supabase.from('products').select('*');

        if (error) {
          productsDiv.textContent = `無法獲取商品列表: ${error.message}`;
          console.error(error);
          return;
        }

        products.forEach(product => {
          const productDiv = document.createElement('div');
          productDiv.className = 'product';
          productDiv.innerHTML = `
            <p>${product.name} - $${product.price.toFixed(2)}</p>
            <button onclick="addToCart(${product.id}, ${product.price})">加入購物車</button>
            <button onclick="deleteProduct(${product.id})" style="color: red;">刪除</button>
          `;
          productsDiv.appendChild(productDiv);
        });
      } catch (err) {
        productsDiv.textContent = '無法獲取商品列表！';
        console.error(err);
      }
    }

    // 刪除商品
    async function deleteProduct(productId) {
      if (confirm('確定要刪除此商品嗎？')) {
        await supabase.from('products').delete().eq('id', productId);
        renderProductList();
      }
    }

    // 新增使用者
    async function addUser() {
      const username = document.getElementById('new-username').value.trim();
      const errorMsg = document.getElementById('user-error-msg');

      if (!username) {
        errorMsg.textContent = '使用者名稱不可為空！';
        return;
      }

      try {
        const { data, error } = await supabase.from('users').insert([{ username }]);

        if (error) {
          errorMsg.textContent = `新增使用者失敗: ${error.message}`;
          console.error(error);
        } else {
          alert("使用者新增成功！");
          renderUserList();
        }
      } catch (err) {
        errorMsg.textContent = `新增使用者時發生錯誤: ${err.message}`;
        console.error(err);
      }

      document.getElementById('new-username').value = '';
    }

    // 渲染使用者列表
    async function renderUserList() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';

      try {
        const { data: users, error } = await supabase.from('users').select('*');

        if (error) {
          userList.textContent = `無法獲取使用者列表: ${error.message}`;
          console.error(error);
          return;
        }

        users.forEach(user => {
          const userItem = document.createElement('li');
          userItem.className = 'user-item';
          userItem.innerHTML = `
            <span>${user.username}</span>
            <div>
              <button onclick="selectUser('${user.username}')">切換</button>
              <button onclick="deleteUser(${user.id})">刪除</button>
            </div>
          `;
          userList.appendChild(userItem);
        });
      } catch (err) {
        userList.textContent = '無法獲取使用者列表！';
        console.error(err);
      }
    }

    // 選擇當前使用者
    function selectUser(username) {
      currentUser = username;
      updateCartDisplay(username);
    }

    // 刪除使用者
    async function deleteUser(userId) {
      if (confirm('確定要刪除此使用者嗎？')) {
        await supabase.from('users').delete().eq('id', userId);
        renderUserList();
      }
    }

    // 加入購物車
    async function addToCart(productId, productPrice) {
      if (!currentUser) {
        alert('請先選擇使用者！');
        return;
      }

      const user = await supabase.from('users').select('id').eq('username', currentUser).single();
      if (!user.data) return;

      try {
        const { error } = await supabase.from('cart_items').insert([
          { user_id: user.data.id, product_id: productId, quantity: 1, total_price: productPrice }
        ]);

        if (error) {
          alert("加入購物車失敗！");
          console.error(error);
        } else {
          alert("商品成功加入購物車！");
          updateCartDisplay(currentUser);
        }
      } catch (err) {
        alert("加入購物車時發生錯誤！");
        console.error(err);
      }
    }

    // 更新購物車展示
    async function updateCartDisplay(username) {
      const cartContainer = document.getElementById('cart-container');
      cartContainer.innerHTML = '';

      const user = await supabase.from('users').select('id').eq('username', username).single();
      if (!user.data) return;

      try {
        const { data: cartItems, error } = await supabase.from('cart_items').select('*, products(name)').eq('user_id', user.data.id);

        if (error) {
          cartContainer.textContent = '無法獲取購物車！';
          console.error(error);
          return;
        }

        cartItems.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'product';
          itemDiv.innerHTML = `
            ${item.products.name} x${item.quantity} - $${item.total_price.toFixed(2)}
            <button onclick="deleteFromCart(${item.id})">刪除</button>
          `;
          cartContainer.appendChild(itemDiv);
        });

        const totalPrice = cartItems.reduce((acc, item) => acc + item.total_price, 0);
        const totalDiv = document.createElement('p');
        totalDiv.textContent = `總金額：$${totalPrice.toFixed(2)}`;
        cartContainer.appendChild(totalDiv);
      } catch (err) {
        cartContainer.textContent = '無法更新購物車！';
        console.error(err);
      }
    }

    // 從購物車中移除
    async function deleteFromCart(cartItemId) {
      await supabase.from('cart_items').delete().eq('id', cartItemId);
      if (currentUser) updateCartDisplay(currentUser);
    }
  </script>
</head>
<body>
  <h1>線上購物平台</h1>

  <div id="product-section">
    <h2>新增商品</h2>
    <input type="text" id="product-name" placeholder="商品名稱">
    <input type="number" id="product-price" placeholder="價格" min="0">
    <button onclick="addProduct()">新增商品</button>
    <p id="product-error-msg"></p>

    <h2>商品列表</h2>
    <div id="products"></div>
  </div>

  <div id="user-section">
    <h2>使用者列表</h2>
    <input type="text" id="new-username" placeholder="新增使用者">
    <button onclick="addUser()">新增使用者</button>
    <p id="user-error-msg"></p>
    <ul id="user-list"></ul>
  </div>

  <div id="checkout-section">
    <h2>購物車</h2>
    <div id="cart-container"></div>
  </div>
</body>
</html>
